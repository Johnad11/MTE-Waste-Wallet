<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MTE Waste Wallet</title>
  <!-- 1. Include Tailwind CSS for styling --><script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Simple fade-in animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out forwards;
    }
    /* Star Rating CSS */
    .rating-stars {
      display: inline-flex;
      flex-direction: row-reverse;
      justify-content: center;
    }
    .rating-stars input {
      display: none;
    }
    .rating-stars label {
      cursor: pointer;
      color: #d1d5db; /* gray-300 */
      font-size: 2.5rem;
      transition: color 0.2s;
    }
    .rating-stars input:checked ~ label,
    .rating-stars label:hover,
    .rating-stars label:hover ~ label {
      color: #f59e0b; /* amber-500 */
    }
    /* Modal backdrop style */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.6);
        transition: opacity 0.3s;
    }
    /* Floating Chat Button style */
    #floating-help-button {
      bottom: 20px; /* Adjusted for mobile footer nav */
      left: 20px;
    }
    @media (min-width: 768px) {
      #floating-help-button {
        bottom: 20px;
        left: 20px;
      }
    }
  </style>
</head>
<body class="flex flex-col h-screen bg-gray-100 font-sans">

  <!-- 2. Header (Static) --><header class="w-full bg-emerald-600 text-white p-4 shadow-md sticky top-0 z-10">
    <div class="max-w-4xl mx-auto flex justify-between items-center">
      <a href="#landing" class="flex items-center gap-2 cursor-pointer">
        <!-- Fancy new logo --><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-recycle">
            <path d="M12 21.3c-2.4 0-4.7-.8-6.5-2.2-1.8-1.4-3-3.4-3-5.6 0-2.2 1.2-4.2 3-5.6 1.8-1.4 4.1-2.2 6.5-2.2s4.7.8 6.5 2.2c1.8 1.4 3 3.4 3 5.6 0 2.2-1.2 4.2-3 5.6-1.8 1.4-4.1 2.2-6.5 2.2zm0-18.6c-1.8 0-3.5.5-4.9 1.4-1.4.9-2.5 2.1-3 3.6h1.5l-2.2 2.2-2.3-2.2h1.5C3.3 6.6 4.6 4.9 6.2 3.8 7.8 2.7 9.8 2.1 12 2.1c2.2 0 4.2.6 5.8 1.7 1.6 1.1 2.9 2.8 3.5 4.7h-1.5l2.3 2.2 2.2-2.2h-1.5c-.6-1.8-1.7-3.4-3-4.4-1.3-1-2.9-1.5-4.6-1.5zM12 11c-.4 0-.8.1-1.1.4-.3.3-.4.7-.4 1.1s.1.8.4 1.1c.3.3.7.4 1.1.4s.8-.1 1.1-.4c.3-.3.4-.7.4-1.1s-.1-.8-.4-1.1c-.3-.3-.7-.4-1.1-.4z"></path>
            <circle cx="12" cy="12" r="3" fill="currentColor"/>
            <path d="M12 5.5V3.5M12 20.5v-2M18.5 12h2M3.5 12h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <h1 class="text-2xl font-bold">MTE Waste Wallet</h1>
      </a>
      <!-- Logout button will be shown/hidden by JS --><button
        id="logout-button"
        onclick="app.logout()"
        class="hidden text-sm font-medium bg-emerald-700 hover:bg-emerald-800 px-3 py-2 rounded-lg transition-colors"
      >
        Log Out
      </button>
    </div>
  </header>

  <!-- 3. Main Content Area (Dynamic) --><main class="flex-1 overflow-y-auto p-4 md:p-6">
    <div id="app-root" class="max-w-4xl mx-auto">
      <!-- Content is dynamically inserted here --></div>
  </main>
  
  <!-- 4. Loading Spinner (Static, hidden by default) --><div id="loading-spinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="w-16 h-16 border-4 border-t-emerald-500 border-gray-200 rounded-full animate-spin"></div>
  </div>
  
  <!-- 5. Footer Navigation (Static) --><footer id="footer-nav" class="hidden w-full bg-white border-t border-gray-200 p-4 sticky bottom-0 z-10 md:hidden">
    <nav id="household-nav" class="hidden max-w-4xl mx-auto flex justify-around items-center">
      <!-- Household Nav Buttons --><button onclick="app.navigate('dashboard')" class="nav-button flex flex-col items-center" data-page="dashboard">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M11.54 22.351l.07.04.028.016a.76.76 0 0 0 .723 0l.028-.015.071-.041A16.975 16.975 0 0 0 12 21.75a16.975 16.975 0 0 0-6.592 1.656l-.071.041-.028.015a.76.76 0 0 0 0 1.447l.028.015.07.041A16.975 16.975 0 0 0 12 21.75ZM12 7.5a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5ZM12 11.25a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5ZM1.146 10.125a.75.75 0 0 1 .75 0h.01a.75.75 0 0 1 0 1.5H1.896a.75.75 0 0 1-.75-1.5ZM21.104 10.125a.75.75 0 0 1 .75 0h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-1.5Z" clipRule="evenodd" /></svg>
        <span class="text-xs font-medium">Home</span>
      </button>
      <button onclick="app.navigate('newRequest')" class="nav-button flex flex-col items-center" data-page="newRequest">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fillRule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V9Z" clipRule="evenodd" /></svg>
        <span class="text-xs font-medium">New Request</span>
      </button>
      <button onclick="app.navigate('smartScan')" class="nav-button flex flex-col items-center" data-page="smartScan">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M1.5 6h21v12H1.5V6ZM3 16.5h18V7.5H3v9ZM12 9a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0v-4.5A.75.75 0 0 0 12 9Z" /><path d="M3.75 3h16.5c.966 0 1.75.784 1.75 1.75v14.5c0 .966-.784 1.75-1.75 1.75H3.75c-.966 0-1.75-.784-1.75-1.75V4.75C2 3.784 2.784 3 3.75 3Z" /></svg>
        <span class="text-xs font-medium">SmartScan</span>
      </button>
    </nav>
    <nav id="collector-nav" class="hidden max-w-4xl mx-auto flex justify-around items-center">
      <!-- Collector Nav Buttons --><button onclick="app.navigate('dashboard')" class="nav-button flex flex-col items-center" data-page="dashboard">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M11.47 3.84a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 0 1.06-1.06l-8.689-8.69a2.25 2.25 0 0 0-3.182 0L2.47 11.47a.75.75 0 1 0 1.06 1.06l8.69-8.69Z" /><path d="m12 5.432 8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75V21a.75.75 0 0 1-.75.75H5.625a1.875 1.875 0 0 1-1.875-1.875v-6.198c.031-.028.061-.056.091-.086L12 5.432Z" /></svg>
        <span class="text-xs font-medium">Pickups</span>
      </button>
    </nav>
  </footer>

  <!-- 7. Floating Help Button (New) -->
  <button
    id="floating-help-button"
    onclick="app.showSupportModal()"
    class="fixed z-40 bg-emerald-600 text-white p-4 rounded-full shadow-lg hover:bg-emerald-700 transition-transform transform hover:scale-105"
  >
    <!-- Chat Icon --><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
        <path d="M4.91 4.91A12.016 12.016 0 0 1 12 2.25c.82 0 1.638.077 2.441.229 2.01.378 3.753 1.488 4.793 3.013.829 1.205 1.25 2.585 1.25 4.025a7.5 7.5 0 0 0-7.5-7.5ZM12 18a.75.75 0 0 0-.75.75v3a.75.75 0 0 0 1.5 0v-3A.75.75 0 0 0 12 18ZM5.25 12a.75.75 0 0 0 .75.75h3a.75.75 0 0 0 0-1.5H6a.75.75 0 0 0-.75.75ZM15 12a.75.75 0 0 0 .75.75h3a.75.75 0 0 0 0-1.5h-3a.75.75 0 0 0-.75.75Z" />
        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12 21.75a9.75 9.75 0 1 1 0-19.5 9.75 9.75 0 0 1 0 19.5Z" clip-rule="evenodd" /></svg>
  </button>
  
  <!-- 8. Support Modal (New) -->
  <div id="support-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm transform scale-95 transition-transform duration-300">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">Help & Support</h3>
        <button onclick="app.hideSupportModal()" class="text-gray-400 hover:text-gray-600">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>
        </button>
      </div>

      <div class="space-y-4">
        <!-- Urgent Support -->
        <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-red-800">Urgent Complaints</h4>
          <p class="text-red-700 text-sm">(Mon-Fri, 9am-5pm)</p>
          <div class="mt-2 space-y-1">
            <p class="text-gray-800 font-medium">Households: <a href="tel:+234800000001" class="text-red-600 hover:underline">+234 800 000 001</a></p>
            <p class="text-gray-800 font-medium">Collectors: <a href="tel:+234800000002" class="text-red-600 hover:underline">+234 800 000 002</a></p>
          </div>
        </div>

        <!-- General Support -->
        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-blue-800">General Support & Enquiries</h4>
          <p class="text-blue-700 text-sm">We aim to respond within 24 hours.</p>
          <a 
            href="mailto:support@mtewastewallet.com" 
            class="block mt-3 bg-blue-600 text-white font-bold py-2 px-4 text-center rounded-lg hover:bg-blue-700 transition-colors"
          >
            Email: support@mtewastewallet.com
          </a>
        </div>
      </div>
      
      <!-- Back Button - REMOVED -->
      <!-- The user can close the modal using the 'X' button or click outside -->
    </div>
  </div>

  <!-- 6. JavaScript Application Logic --><script>
    // --- API Configuration ---
    const GEMINI_API_KEY = ""; // Keep this as an empty string.
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

    /**
     * Main application object.
     * Manages state, routing, and rendering.
     */
    const app = {
      // --- STATE ---
      loggedInUser: null, // { uid: 'h1', role: 'household', name: 'Household User' }
      currentPage: 'landing', // 'landing', 'household-login', ... 'rateRequest'
      error: null,
      isLoading: false,
      base64Image: null, // For SmartScan
      
      // --- SIMULATED DATABASE ---
      db: {
        households: [
          { uid: 'h1', name: 'Household User', email: 'household@test.com' }
        ],
        collectors: [
          { uid: 'c1', name: 'Green Lagos Recyclers', email: 'green@test.com', rating: 4.5, reviewCount: 82, jobsCompleted: 120 },
          { uid: 'c2', name: 'EcoSpeed Collectors', email: 'eco@test.com', rating: 4.1, reviewCount: 45, jobsCompleted: 75 }
        ],
        pickupRequests: [
          {
            id: 1,
            householdId: 'h1',
            address: '123 Ikoyi Lane, Lagos',
            wasteType: 'Plastics',
            description: 'Two large bags of water bottles.',
            photoUrl: 'https://placehold.co/300x200/3498db/ffffff?text=Plastic+Bags',
            status: 'pending', // 'pending', 'accepted', 'completed', 'rated'
            collectorId: null,
            timestamp: new Date(Date.now() - 3600000).toISOString(),
          },
          {
            id: 2,
            householdId: 'h1',
            address: '123 Ikoyi Lane, Lagos',
            wasteType: 'Cans',
            description: '',
            photoUrl: 'https://placehold.co/300x200/95a5a6/ffffff?text=Aluminum+Cans',
            status: 'accepted',
            collectorId: 'c1',
            timestamp: new Date(Date.now() - 7200000).toISOString(),
          },
          {
            id: 3,
            householdId: 'h1',
            address: '123 Ikoyi Lane, Lagos',
            wasteType: 'General Waste',
            description: 'One big black bag.',
            photoUrl: 'https://placehold.co/300x200/34495e/ffffff?text=General+Waste',
            status: 'completed',
            collectorId: 'c2',
            timestamp: new Date(Date.now() - 86400000).toISOString(),
          },
          {
            id: 4,
            householdId: 'h1',
            address: '456 Allen Avenue, Ikeja',
            wasteType: 'Plastics',
            description: '',
            photoUrl: 'https://placehold.co/300x200/3498db/ffffff?text=Plastic+Bags',
            status: 'pending',
            collectorId: null,
            timestamp: new Date(Date.now() - 172800000).toISOString(),
          },
          {
            id: 5,
            householdId: 'h1',
            address: '123 Ikoyi Lane, Lagos',
            wasteType: 'Glass',
            description: 'Box of bottles.',
            photoUrl: 'https://placehold.co/300x200/1abc9c/ffffff?text=Glass+Bottles',
            status: 'rated',
            collectorId: 'c1',
            timestamp: new Date(Date.now() - 259200000).toISOString(),
            rating: 5,
            review: 'Great service! Very fast.'
          },
        ]
      },

      // --- DOM Elements ---
      elements: {
        root: null,
        loader: null,
        logoutBtn: null,
        footer: null,
        householdNav: null,
        collectorNav: null,
        supportModal: null, // NEW: Support Modal
        floatingButton: null, // NEW: Floating Button
      },

      /**
       * Initializes the app, finds DOM elements, and renders the first page.
       */
      init() {
        this.elements.root = document.getElementById('app-root');
        this.elements.loader = document.getElementById('loading-spinner');
        this.elements.logoutBtn = document.getElementById('logout-button');
        this.elements.footer = document.getElementById('footer-nav');
        this.elements.householdNav = document.getElementById('household-nav');
        this.elements.collectorNav = document.getElementById('collector-nav');
        this.elements.supportModal = document.getElementById('support-modal'); // NEW
        this.elements.floatingButton = document.getElementById('floating-help-button'); // NEW
        
        // --- Set up hash-based routing ---
        window.addEventListener('hashchange', () => this.handleHashChange());
        this.handleHashChange(); // Load initial page
      },
      
      // --- STATE MANAGEMENT ---
      
      setLoading(isLoading) {
        this.isLoading = isLoading;
        this.elements.loader.classList.toggle('hidden', !isLoading);
      },
      
      setError(message) {
        this.error = message;
        this.render(); // Re-render to show/hide error
      },
      
      // --- AUTHENTICATION ---
      
      /**
       * Simulates a successful login
       * @param {string} role - 'household' or 'collector'
       */
      login(role) {
        if (role === 'household') {
          this.loggedInUser = this.db.households[0];
          this.loggedInUser.role = 'household';
        } else {
          this.loggedInUser = this.db.collectors[0]; // Log in as "Green Lagos Recyclers"
          this.loggedInUser.role = 'collector';
        }
        this.navigate('dashboard');
      },
      
      logout() {
        this.loggedInUser = null;
        this.navigate('landing');
      },
      
      // --- MODAL HANDLING (NEW) ---

      showSupportModal() {
        const modal = this.elements.supportModal;
        modal.classList.remove('hidden');
        // Force reflow to enable transition
        void modal.offsetWidth; 
        modal.classList.remove('opacity-0');
        modal.querySelector('div').classList.remove('scale-95');

        // Allow closing modal by clicking the backdrop
        modal.onclick = (event) => {
            if (event.target === modal) {
                this.hideSupportModal();
            }
        };
      },

      hideSupportModal() {
        const modal = this.elements.supportModal;
        modal.classList.add('opacity-0');
        modal.querySelector('div').classList.add('scale-95');
        // Hide fully after transition completes
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.onclick = null; // Clean up backdrop listener
        }, 300);
      },

      
      // --- NAVIGATION (USES URL HASHES) ---
      
      navigate(page) {
        window.location.hash = page;
      },

      /**
       * Handles URL hash changes. This is the main controller for routing.
       */
      handleHashChange() {
        const hash = window.location.hash;
        
        // Determine the page from the hash
        let page = hash.split('?')[0].replace('#', '') || 'landing';
        
        // Protected pages that require login
        const protectedPages = ['dashboard', 'newRequest', 'smartScan', 'rateRequest'];
        
        // Auth pages that should NOT be seen when logged in
        const authPages = ['landing', 'household-login', 'household-register', 'collector-login', 'collector-register'];

        if (!this.loggedInUser && protectedPages.includes(page)) {
          // If user is not logged in and tries to access a protected page
          this.currentPage = 'landing';
          window.location.hash = 'landing';
        } else if (this.loggedInUser && authPages.includes(page)) {
          // If user IS logged in and tries to access an auth page
          this.currentPage = 'dashboard';
          window.location.hash = 'dashboard';
        } else {
          // Otherwise, the page is valid
          this.currentPage = page;
        }

        this.error = null; // Clear error on navigation
        this.render();
      },
      
      /**
       * Main render function. Decides what to show based on state.
       */
      render() {
        let content = '';
        this.clearError(); // Clear any existing error banners
        
        if (this.error) {
          this.showError(this.error);
        }

        // 1. Update UI elements based on auth state
        this.elements.logoutBtn.classList.toggle('hidden', !this.loggedInUser);
        this.elements.footer.classList.toggle('hidden', !this.loggedInUser);
        this.elements.householdNav.classList.toggle('hidden', this.loggedInUser?.role !== 'household');
        this.elements.collectorNav.classList.toggle('hidden', this.loggedInUser?.role !== 'collector');
        
        // 2. Render content based on page and role
        if (!this.loggedInUser) {
          // --- AUTH PAGES (Logged Out) ---
          switch (this.currentPage) {
            case 'household-login':
              content = this.renderAuthForm('household', 'login');
              break;
            case 'household-register':
              content = this.renderAuthForm('household', 'register');
              break;
            case 'collector-login':
              content = this.renderAuthForm('collector', 'login');
              break;
            case 'collector-register':
              content = this.renderAuthForm('collector', 'register');
              break;
            case 'landing':
            default:
              content = this.renderLandingPage();
              break;
          }
        } else if (this.loggedInUser.role === 'household') {
          // --- HOUSEHOLD PAGES (Logged In) ---
          switch (this.currentPage) {
            case 'newRequest':
              content = this.renderNewRequestForm();
              break;
            case 'smartScan':
              content = this.renderSmartScan();
              break;
            case 'rateRequest':
              content = this.renderRatingForm();
              break;
            case 'dashboard':
            default:
              content = this.renderHouseholdDashboard();
          }
        } else if (this.loggedInUser.role === 'collector') {
          // --- COLLECTOR PAGES (Logged In) ---
           switch (this.currentPage) {
            case 'dashboard':
            default:
              content = this.renderCollectorDashboard();
           }
        }
        
        this.elements.root.innerHTML = content;
        
        // 3. Update footer nav state
        this.updateNavButtons();
        
        // 4. Re-attach event listeners for dynamic content
        this.attachEventListeners();
      },
      
      /**
       * Attaches listeners to dynamically created elements.
       */
      attachEventListeners() {
        // --- Auth Forms ---
        const householdLoginForm = document.getElementById('household-login-form');
        if (householdLoginForm) householdLoginForm.onsubmit = (e) => this.handleAuthFormSubmit(e, 'household', 'login');
        
        const householdRegisterForm = document.getElementById('household-register-form');
        if (householdRegisterForm) householdRegisterForm.onsubmit = (e) => this.handleAuthFormSubmit(e, 'household', 'register');

        const collectorLoginForm = document.getElementById('collector-login-form');
        if (collectorLoginForm) collectorLoginForm.onsubmit = (e) => this.handleAuthFormSubmit(e, 'collector', 'login');
        
        const collectorRegisterForm = document.getElementById('collector-register-form');
        if (collectorRegisterForm) collectorRegisterForm.onsubmit = (e) => this.handleAuthFormSubmit(e, 'collector', 'register');

        // --- New Request Form ---
        const newRequestForm = document.getElementById('new-request-form');
        if (newRequestForm) {
          newRequestForm.onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const requestData = {
              address: formData.get('address'),
              wasteType: formData.get('wasteType'),
              description: formData.get('description'),
            };
            this.handleNewRequest(requestData);
          };
        }
        
        // --- Rating Form ---
        const ratingForm = document.getElementById('rating-form');
        if (ratingForm) ratingForm.onsubmit = (e) => this.handleRateSubmit(e);
        
        // --- SmartScan Listeners ---
        const fileUpload = document.getElementById('file-upload');
        if (fileUpload) fileUpload.onchange = (e) => this.handleFileChange(e);
        
        const scanButton = document.getElementById('scan-button');
        if (scanButton) scanButton.onclick = () => this.handleScan();
      },
      
      // --- PAGE RENDERING (HTML STRING TEMPLATES) ---
      
      renderLandingPage() {
        return `
          <div class="animate-fadeIn space-y-8">
            <!-- Hero Section --><div class="bg-white rounded-lg shadow-lg overflow-hidden">
              <div class="p-8 md:p-12">
                <div class="md:flex md:items-center md:gap-8">
                  <div class="md:flex-shrink-0 text-center md:text-left">
                    <svg class="w-24 h-24 md:w-32 md:h-32 text-emerald-500 mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12.378 1.602a.75.75 0 0 0-.756 0L3 6.632l9 15.75 9-15.75-8.622-5.03ZM12 10.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                      <path d="M12 3.832a.75.75 0 0 0-.599.28l-6.323 11.065a.75.75 0 0 0 .65 1.118H18.27a.75.75 0 0 0 .652-1.118L12.6 4.112a.75.75 0 0 0-.6-.28ZM12 10.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                    </svg>
                  </div>
                  <div class="mt-6 md:mt-0">
                    <h2 class="text-3xl font-bold text-gray-900 md:text-4xl">Turn Your Waste into Value.</h2>
                    <p class="mt-4 text-lg text-gray-600">
                      Welcome to MTE Waste Wallet, Nigeria's smart solution for waste management. We connect households with local collectors to make recycling simple, efficient, and reliable.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Our Mission Section --><div class="bg-white p-8 rounded-lg shadow-lg">
              <h3 class="text-2xl font-bold text-emerald-700 text-center mb-4">Our Mission: A Cleaner Nigeria</h3>
              <p class="text-gray-600 text-center max-w-2xl mx-auto">
                We're tackling <strong>SDG 11: Sustainable Cities and Communities</strong>. Our goal is to reduce landfill waste, keep our neighborhoods clean, and empower local collectors by providing them with reliable, direct access to jobs.
              </p>
            </div>

            <!-- How It Works Section --><div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <!-- For Households --><div class="bg-white p-8 rounded-lg shadow-lg">
                <h4 class="text-2xl font-bold text-gray-800 mb-4">For Households</h4>
                <p class="text-gray-600 mb-6">Get your waste picked up reliably and learn how to sort properly.</p>
                <ol class="space-y-4">
                  <li class="flex items-start gap-3">
                    <span class="flex-shrink-0 bg-emerald-500 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm">1</span>
                    <div>
                      <h5 class="font-semibold">Sort & Scan</h5>
                      <p class="text-gray-500 text-sm">Use our <strong>SmartScan</strong> AI feature to instantly identify items and learn the correct recycling bin.</p>
                    </div>
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="flex-shrink-0 bg-emerald-500 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm">2</span>
                    <div>
                      <h5 class="font-semibold">Request Pickup</h5>
                      <p class="text-gray-500 text-sm">Schedule a pickup for your sorted waste (or even general waste) in just a few clicks.</p>
                    </div>
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="flex-shrink-0 bg-emerald-500 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm">3</span>
                    <div>
                      <h5 class="font-semibold">Get Matched</h5>
                      <p class="text-gray-500 text-sm">A verified, local collector accepts your job. You see their rating and profile before they arrive.</p>
                    </div>
                  </li>
                </ol>
              </div>

              <!-- For Collectors --><div class="bg-white p-8 rounded-lg shadow-lg">
                <h4 class="text-2xl font-bold text-gray-800 mb-4">For Collectors</h4>
                <p class="text-gray-600 mb-6">Grow your business, find more jobs, and work more efficiently.</p>
                <ol class="space-y-4">
                  <li class="flex items-start gap-3">
                    <span class="flex-shrink-0 bg-gray-700 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm">1</span>
                    <div>
                      <h5 class="font-semibold">Find Pickups</h5>
                      <p class="text-gray-500 text-sm">Get instant alerts for new pickup requests in your area, from sorted recyclables to general waste.</p>
                    </div>
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="flex-shrink-0 bg-gray-700 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm">2</span>
                    <div>
                      <h5 class="font-semibold">Optimize Your Route</h5>
                      <p class="text-gray-500 text-sm">See all your accepted jobs on a map, helping you plan the most efficient route and save on fuel.</p>
                    </div>
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="flex-shrink-0 bg-gray-700 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm">3</span>
                    <div>
                      <h5 class="font-semibold">Build Your Trust Score</h5>
                      <p class="text-gray-500 text-sm">Complete jobs reliably and get good ratings from households to get more high-value jobs.</p>
                    </div>
                  </li>
                </ol>
              </div>
            </div>

            <!-- Call to Action (Login/Register) --><div class="bg-white p-8 rounded-lg shadow-lg text-center">
              <h3 class="text-2xl font-bold text-gray-800 mb-6">Get Started Today</h3>
              <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button
                  onclick="app.navigate('household-login')"
                  class="flex-1 bg-emerald-600 text-white font-bold py-4 px-6 rounded-lg shadow-md hover:bg-emerald-700 transition-all transform hover:-translate-y-0.5"
                >
                  Household Login/Register
                </button>
                <button
                  onclick="app.navigate('collector-login')"
                  class="flex-1 bg-gray-700 text-white font-bold py-4 px-6 rounded-lg shadow-md hover:bg-gray-800 transition-all transform hover:-translate-y-0.5"
                >
                  Collector Login/Register
                </button>
              </div>
            </div>
            
          </div>
        `;
      },
      
      /**
       * Renders the correct auth form based on role and mode.
       * @param {string} role - 'household' or 'collector'
       * @param {string} mode - 'login' or 'register'
       */
      renderAuthForm(role, mode) {
        const isHousehold = role === 'household';
        const isLogin = mode === 'login';
        
        const title = `${isLogin ? 'Welcome Back!' : 'Create Your Account'}`;
        const formId = `${role}-${mode}-form`;
        const submitText = isLogin ? 'Login' : 'Register';
        
        let fields = '';
        let toggleLink = '';
        let storyTitle = '';
        let storyText = '';
        let storyIcon = '';
        let storyBgClass = '';
        
        if (isHousehold) {
          // --- Household Story & Fields ---
          storyTitle = isLogin ? 'Welcome, Neighbour!' : 'Join the Community';
          storyText = isLogin 
            ? 'Log in to schedule your next pickup and help keep our community clean.' 
            : 'Create an account to start recycling, track your pickups, and use our SmartScan AI tool.';
          storyIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-20 h-20 text-emerald-500"><path d="M11.47 3.84a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 0 1.06-1.06l-8.689-8.69a2.25 2.25 0 0 0-3.182 0L2.47 11.47a.75.75 0 1 0 1.06 1.06l8.69-8.69Z" /><path d="m12 5.432 8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75V21a.75.75 0 0 1-.75.75H5.625a1.875 1.875 0 0 1-1.875-1.875v-6.198c.031-.028.061-.056.091-.086L12 5.432Z" /></svg>`;
          storyBgClass = 'bg-emerald-50';

          if (!isLogin) {
            fields += `
              <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                <input type="text" id="name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
              </div>
              <div>
                <label for="number" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                <input type="tel" id="number" name="number" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
              </div>
            `;
          }
          fields += `
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input type="email" id="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
            </div>
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
              <input type="password" id="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
            </div>
          `;
          if (!isLogin) {
            fields += `
              <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
              </div>
            `;
          }
          toggleLink = isLogin
            ? `<a href="#household-register" class="font-medium text-emerald-600 hover:text-emerald-500">Need an account? Register</a>`
            : `<a href="#household-login" class="font-medium text-emerald-600 hover:text-emerald-500">Already have an account? Login</a>`;
            
        } else {
          // --- Collector Story & Fields ---
          storyTitle = isLogin ? 'Welcome, Partner!' : 'Grow Your Business';
          storyText = isLogin
            ? 'Log in to find new jobs, manage your pickups, and plan your routes.'
            : 'Register as an official MTE Waste Wallet collector to get direct access to jobs in your area.';
          storyIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-20 h-20 text-gray-700"><path d="M14.25 5.25a.75.75 0 0 0-.75.75v.5c0 .414.336.75.75.75h5.25a.75.75 0 0 0 0-1.5h-4.5v-.5a.75.75 0 0 0-.75-.75Z" /><path fill-rule="evenodd" d="M3 8.25A2.25 2.25 0 0 1 5.25 6h13.5A2.25 2.25 0 0 1 21 8.25v9a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 17.25v-9ZM5.25 7.5a.75.75 0 0 0-.75.75v9c0 .414.336.75.75.75h13.5a.75.75 0 0 0 .75-.75v-9a.75.75 0 0 0-.75-.75H5.25Z" clip-rule="evenodd" /><path d="M9.75 10.5a.75.75 0 0 1 .75.75v3a.75.75 0 0 1-1.5 0v-3a.75.75 0 0 1 .75-.75Zm3 0a.75.75 0 0 1 .75.75v3a.75.75 0 0 1-1.5 0v-3a.75.75 0 0 1 .75-.75Zm3 0a.75.75 0 0 1 .75.75v3a.75.75 0 0 1-1.5 0v-3a.75.75 0 0 1 .75-.75Z" /></svg>`;
          storyBgClass = 'bg-gray-200';

          if (!isLogin) {
            fields += `
              <div>
                <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                <input type="text" id="companyName" name="companyName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500" />
              </div>
              <div>
                <label for="companyAddress" class="block text-sm font-medium text-gray-700 mb-1">Company Address</label>
                <input type="text" id="companyAddress" name="companyAddress" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500" />
              </div>
              <div>
                <label for="companyNumber" class="block text-sm font-medium text-gray-700 mb-1">Company Phone Number</label>
                <input type="tel" id="companyNumber" name="companyNumber" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500" />
              </div>
            `;
          }
           fields += `
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-1">${isLogin ? 'Company Email / Reg. Number' : 'Company Email'}</label>
              <input type="text" id="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500" />
            </div>
            ${!isLogin ? `
              <div>
                <label for="regNumber" class="block text-sm font-medium text-gray-700 mb-1">Company Registration Number</label>
                <input type="text" id="regNumber" name="regNumber" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500" />
              </div>
            ` : ''}
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
              <input type="password" id="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500" />
            </div>
          `;
          if (!isLogin) {
            fields += `
              <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500" />
              </div>
            `;
          }
          toggleLink = isLogin
            ? `<a href="#collector-register" class="font-medium text-emerald-600 hover:text-emerald-500">Need an account? Register</a>`
            : `<a href="#collector-login" class="font-medium text-emerald-600 hover:text-emerald-500">Already have an account? Login</a>`;
        }

        return `
          <div class="bg-white shadow-lg rounded-lg overflow-hidden animate-fadeIn max-w-4xl mx-auto md:flex">
            <!-- Storytelling Column --><div class="hidden md:flex flex-col justify-center items-center text-center p-8 md:w-1/2 ${storyBgClass}">
              <div class="p-4">
                ${storyIcon}
                <h3 class="text-2xl font-bold text-gray-800 mt-4">${storyTitle}</h3>
                <p class="text-gray-600 mt-2">${storyText}</p>
              </div>
              <button onclick="app.navigate('landing')" class="text-sm text-gray-500 hover:text-gray-700 mt-6 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 0 1-.02 1.06L8.832 10l3.938 3.71a.75.75 0 1 1-1.04 1.08l-4.5-4.25a.75.75 0 0 1 0-1.08l4.5-4.25a.75.75 0 0 1 1.06.02Z" clip-rule="evenodd" /></svg>
                Back to Home
              </button>
            </div>
            
            <!-- Form Column --><div class="p-6 md:p-8 md:w-1/2">
              <button onclick="app.navigate('landing')" class="text-sm text-gray-500 hover:text-gray-700 mb-4 flex items-center gap-1 md:hidden">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 0 1-.02 1.06L8.832 10l3.938 3.71a.75.75 0 1 1-1.04 1.08l-4.5-4.25a.75.75 0 0 1 0-1.08l4.5-4.25a.75.75 0 0 1 1.06.02Z" clip-rule="evenodd" /></svg>
                Back
              </button>
              <h2 class="text-2xl font-bold text-gray-800 mb-6">${title}</h2>
              <form id="${formId}" class="space-y-4">
                ${fields}
                <div>
                  <button
                    type="submit"
                    class="w-full font-semibold py-3 px-4 rounded-lg shadow transition-colors ${isHousehold ? 'bg-emerald-600 text-white hover:bg-emerald-700' : 'bg-gray-700 text-white hover:bg-gray-800'}"
                  >
                    ${submitText}
                  </button>
                </div>
                <p class="text-sm text-center text-gray-600">
                  ${toggleLink}
                </p>
              </form>
            </div>
          </div>
        `;
      },
      
      renderHouseholdDashboard() {
        // Find all requests for the logged-in household
        const myRequests = this.db.pickupRequests
          .filter(r => r.householdId === this.loggedInUser.uid)
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Show newest first

        const pendingHtml = myRequests
          .filter(r => r.status === 'pending')
          .map(req => this.renderRequestCard(req, 'household'))
          .join('') || '<p class="text-gray-500 px-4">No pending requests.</p>';

        const acceptedHtml = myRequests
          .filter(r => r.status === 'accepted')
          .map(req => this.renderRequestCard(req, 'household'))
          .join('') || '<p class="text-gray-500 px-4">No accepted requests.</p>';
          
        const needsRatingHtml = myRequests
          .filter(r => r.status === 'completed')
          .map(req => this.renderRequestCard(req, 'household'))
          .join('') || '<p class="text-gray-500 px-4">No pickups to rate.</p>';

        const historyHtml = myRequests
          .filter(r => r.status === 'rated')
          .map(req => this.renderRequestCard(req, 'household'))
          .join('') || '<p class="text-gray-500 px-4">No past history.</p>';

        return `
          <div class="animate-fadeIn space-y-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold text-gray-800">My Dashboard</h2>
              <div class="hidden md:flex gap-2">
                 <button
                  onclick="app.navigate('smartScan')"
                  class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M1.5 6h21v12H1.5V6ZM3 16.5h18V7.5H3v9ZM12 9a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0v-4.5A.75.75 0 0 0 12 9Z" /><path d="M3.75 3h16.5c.966 0 1.75.784 1.75 1.75v14.5c0 .966-.784 1.75-1.75 1.75H3.75c-.966 0-1.75-.784-1.75-1.75V4.75C2 3.784 2.784 3 3.75 3Z" /></svg>
                  SmartScan
                </button>
                <button
                  onclick="app.navigate('newRequest')"
                  class="bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-emerald-700 transition-colors flex items-center gap-2"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V9Z" clipRule="evenodd" /></svg>
                  New Request
                </button>
              </div>
            </div>
            
            <!-- Section: Needs Rating -->
            <div>
              <h3 class="text-xl font-semibold text-gray-700 mb-4">Needs Your Rating</h3>
              <div class="space-y-4">
                ${needsRatingHtml}
              </div>
            </div>
            
            <!-- Section: Accepted -->
            <div>
              <h3 class="text-xl font-semibold text-gray-700 mb-4">Accepted (On The Way)</h3>
              <div class="space-y-4">
                ${acceptedHtml}
              </div>
            </div>
            
            <!-- Section: Pending -->
            <div>
              <h3 class="text-xl font-semibold text-gray-700 mb-4">Pending Pickups</h3>
              <div class="space-y-4">
                ${pendingHtml}
              </div>
            </div>
            
            <!-- Section: History -->
            <div>
              <h3 class="text-xl font-semibold text-gray-700 mb-4">Pickup History</h3>
              <div class="space-y-4">
                ${historyHtml}
              </div>
            </div>
            
          </div>
        `;
      },
      
      renderNewRequestForm() {
        // ... (same as before)
        return `
          <form id="new-request-form" class="bg-white p-6 rounded-lg shadow-lg animate-fadeIn space-y-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">New Pickup Request</h2>
            
            <div>
              <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
              <input
                type="text"
                id="address"
                name="address"
                placeholder="e.g., 123 Ikoyi Lane, Lagos"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
              />
            </div>
            
            <div>
              <label for="wasteType" class="block text-sm font-medium text-gray-700 mb-1">Type of Waste</label>
              <select
                id="wasteType"
                name="wasteType"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
              >
                <option>Plastics</option>
                <option>Cans</option>
                <option>Cardboard</option>
                <option>Glass</option>
                <option>General Waste</option>
                <option>Mixed</option>
              </select>
            </div>

            <div>
              <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                Optional Description (e.g., "3 large bags")
              </label>
              <textarea
                id="description"
                name="description"
                rows="3"
                placeholder="Add any extra details for the collector here."
                class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
              ></textarea>
            </div>
            
            <div class="flex gap-4 pt-2">
              <button
                type="button"
                onclick="app.navigate('dashboard')"
                class="flex-1 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="flex-1 bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-emerald-700 transition-colors"
              >
                Submit Request
              </button>
            </div>
          </form>
        `;
      },
      
      renderCollectorDashboard() {
        const myJobs = this.db.pickupRequests
          .filter(r => r.collectorId === this.loggedInUser.uid && r.status === 'accepted')
          .map(req => this.renderRequestCard(req, 'collector'))
          .join('') || '<p class="text-gray-500 px-4">You have no accepted jobs.</p>';
          
        const availableJobs = this.db.pickupRequests
          .filter(r => r.status === 'pending')
          .map(req => this.renderRequestCard(req, 'collector'))
          .join('') || '<p class="text-gray-500 px-4">No new jobs available right now.</p>';
          
        return `
          <div class="animate-fadeIn space-y-6">
            <div>
              <h2 class="text-2xl font-bold text-gray-800 mb-4">Collector Dashboard</h2>
              <div class="bg-white p-4 rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold text-gray-800">${this.loggedInUser.name}</h3>
                <div class="flex items-center gap-2 mt-2">
                  <span class="text-amber-500 font-bold text-lg">â˜… ${this.loggedInUser.rating.toFixed(1)}</span>
                  <span class="text-gray-500 text-sm">(${this.loggedInUser.reviewCount} reviews)</span>
                </div>
                <p class="text-gray-600 mt-1">${this.loggedInUser.jobsCompleted} jobs completed.</p>
              </div>
            </div>
            
            <!-- Section: My Accepted Jobs -->
            <div>
              <h3 class="text-xl font-semibold text-gray-700 mb-4">My Accepted Jobs</h3>
              <div class="space-y-4">
                ${myJobs}
              </div>
            </div>
            
            <!-- Section: Available Jobs -->
            <div>
              <h3 class="text-xl font-semibold text-gray-700 mb-4">Available Jobs Near You</h3>
              <div class="space-y-4">
                ${availableJobs}
              </div>
            </div>

          </div>
        `;
      },
      
      /**
       * New page for rating a completed pickup
       */
      renderRatingForm() {
        const requestId = parseInt(window.location.hash.split('?id=')[1]);
        const request = this.db.pickupRequests.find(r => r.id === requestId);
        const collector = this.db.collectors.find(c => c.uid === request.collectorId);

        if (!request || !collector) {
          this.setError('Could not find the pickup to rate.');
          return '<div class="animate-fadeIn"></div>'; // Render nothing
        }
        
        return `
          <div class="bg-white p-6 rounded-lg shadow-lg animate-fadeIn space-y-4">
            <div class="flex items-center gap-2 mb-2">
              <button onclick="app.navigate('dashboard')" class="text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M11.03 3.97a.75.75 0 0 1 0 1.06l-6.22 6.22H21a.75.75 0 0 1 0 1.5H4.81l6.22 6.22a.75.75 0 1 1-1.06 1.06l-7.5-7.5a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 0 1 1.06 0Z" clipRule="evenodd" /></svg>
              </button>
              <h2 class="text-2xl font-bold text-gray-800">Rate Your Pickup</h2>
            </div>
            
            <p class="text-gray-600">How was your experience with <strong>${collector.name}</strong> for the <strong>${request.wasteType}</strong> pickup?</p>
            
            <form id="rating-form" data-request-id="${request.id}" data-collector-id="${collector.uid}">
              <div class="text-center py-4">
                <label class="text-sm font-medium text-gray-700 mb-2 block">Your Rating</label>
                <div class="rating-stars">
                  <input type="radio" id="star5" name="rating" value="5" /><label for="star5">â˜…</label>
                  <input type="radio" id="star4" name="rating" value="4" /><label for="star4">â˜…</label>
                  <input type="radio" id="star3" name="rating" value="3" /><label for="star3">â˜…</label>
                  <input type="radio" id="star2" name="rating" value="2" /><label for="star2">â˜…</label>
                  <input type="radio" id="star1" name="rating" value="1" /><label for="star1">â˜…</label>
                </div>
              </div>
              
              <div>
                <label for="review" class="block text-sm font-medium text-gray-700 mb-1">
                  Leave a Review (Optional)
                </label>
                <textarea
                  id="review"
                  name="review"
                  rows="4"
                  placeholder="e.g., 'Very fast and professional!'"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                ></textarea>
              </div>
              
              <div class="pt-2">
                <button
                  type="submit"
                  class="w-full bg-emerald-600 text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-emerald-700 transition-colors"
                >
                  Submit Review
                </button>
              </div>
            </form>
          </div>
        `;
      },

      renderSmartScan() {
        // ... (same as before)
        return `
          <div class="bg-white p-6 rounded-lg shadow-lg animate-fadeIn space-y-4">
            <div class="flex items-center gap-2 mb-2">
              <button onclick="app.navigate('dashboard')" class="text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M11.03 3.97a.75.75 0 0 1 0 1.06l-6.22 6.22H21a.75.75 0 0 1 0 1.5H4.81l6.22 6.22a.75.75 0 1 1-1.06 1.06l-7.5-7.5a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 0 1 1.06 0Z" clipRule="evenodd" /></svg>
              </button>
              <h2 class="text-2xl font-bold text-gray-800">SmartScan</h2>
            </div>
            
            <p class="text-gray-600">Upload a photo of an item to learn how to recycle it.</p>
            
            <div class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden">
              <img id="scan-preview" src="" alt="Upload preview" class="hidden h-full w-full object-contain" />
              <span id="scan-placeholder" class="text-gray-400">Image preview</span>
            </div>
            
            <div class="flex flex-col md:flex-row gap-2">
              <label
                for="file-upload"
                class="flex-1 cursor-pointer bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors text-center"
              >
                <span id="file-upload-label">Upload Image</span>
              </label>
              <input id="file-upload" type="file" accept="image/*" class="hidden" />
              
              <button
                id="scan-button"
                disabled
                class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Scan Item
              </button>
            </div>

            <!-- AI Result will be injected here --><div id="ai-result-container"></div>
          </div>
        `;
      },
      
      // --- HELPER FUNCTIONS ---
      
      updateNavButtons() {
        if (!this.loggedInUser) return; // No nav buttons if logged out
        document.querySelectorAll('.nav-button').forEach(button => {
          if (button.dataset.page === this.currentPage) {
            button.classList.remove('text-gray-500', 'hover:text-emerald-600');
            button.classList.add('text-emerald-500');
          } else {
            button.classList.add('text-gray-500', 'hover:text-emerald-600');
            button.classList.remove('text-emerald-500');
          }
        });
      },
      
      showError(message) {
        this.clearError();
        const errorHtml = `
          <div id="error-banner" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg relative" role="alert">
            <p class="font-bold">Error</p>
            <p>${message}</p>
            <button onclick="app.clearError()" class="absolute top-2 right-2 text-red-500 hover:text-red-700">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z" clip-rule="evenodd" /></svg>
            </button>
          </div>
        `;
        this.elements.root.insertAdjacentHTML('beforebegin', errorHtml);
      },
      
      clearError() {
        const errorBanner = document.getElementById('error-banner');
        if (errorBanner) {
          errorBanner.remove();
        }
        this.error = null;
      },
      
      timeAgo(isoString) {
        const seconds = Math.floor((new Date() - new Date(isoString)) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " years ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " months ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " days ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " hours ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " minutes ago";
        return Math.floor(seconds) + " seconds ago";
      },
      
      getStatusChip(status) {
        switch (status) {
          case 'pending':
            return `<span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Pending</span>`;
          case 'accepted':
            return `<span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">Accepted</span>`;
          case 'completed':
            return `<span class="text-xs font-medium bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">Completed</span>`;
          case 'rated':
            return `<span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Rated</span>`;
          default:
            return '';
        }
      },
      
      getStarRating(rating) {
        let stars = '';
        for(let i = 1; i <= 5; i++) {
          stars += `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 ${i <= rating ? 'text-amber-500' : 'text-gray-300'}">
            <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434L10.788 3.21Z" clip-rule="evenodd" />
          </svg>`;
        }
        return `<div class="flex items-center">${stars}</div>`;
      },
      
      renderRequestCard(request, role) {
        const collector = request.collectorId ? this.db.collectors.find(c => c.uid === request.collectorId) : null;
        
        let collectorHtml = '';
        if (collector) {
          collectorHtml = `
            <div class="mt-3 pt-3 border-t border-gray-100">
              <h4 class="text-sm font-semibold text-gray-700">Collector:</h4>
              <div class="flex items-center gap-2 mt-1">
                <span class="font-medium text-gray-800">${collector.name}</span>
                <span class="text-amber-500 font-bold text-sm">â˜… ${collector.rating.toFixed(1)}</span>
                <span class="text-gray-400 text-sm">(${collector.reviewCount} reviews)</span>
              </div>
            </div>
          `;
        }
        
        let buttonHtml = '';
        if (role === 'collector') {
          if (request.status === 'pending') {
            buttonHtml = `<button
                onclick="app.handleAcceptRequest(${request.id})"
                class="w-full bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-emerald-700 transition-colors mt-4"
              >
                Accept Job
              </button>`;
          } else if (request.status === 'accepted') {
             buttonHtml = `<button
                onclick="app.handleCompleteRequest(${request.id})"
                class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition-colors mt-4"
              >
                Mark as Complete
              </button>`;
          }
        } else if (role === 'household') {
          if (request.status === 'completed') {
            buttonHtml = `<button
                onclick="app.navigate('rateRequest?id=${request.id}')"
                class="w-full bg-amber-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-amber-600 transition-colors mt-4"
              >
                Rate This Pickup
              </button>`;
          } else if (request.status === 'rated') {
            collectorHtml += `
              <div class="mt-3 pt-3 border-t border-gray-100">
                <h4 class="text-sm font-semibold text-gray-700">Your Rating:</h4>
                <div class="flex items-center gap-2 mt-1">
                  ${this.getStarRating(request.rating)}
                </div>
                ${request.review ? `<p class="text-sm text-gray-600 italic mt-1">"${request.review}"</p>` : ''}
              </div>
            `;
          }
        }

        return `
          <div class="bg-white rounded-lg shadow-md overflow-hidden flex flex-col md:flex-row">
            <img
              src="${request.photoUrl}"
              alt="${request.wasteType}"
              class="w-full h-40 md:w-48 md:h-full object-cover"
              onerror="this.src='https://placehold.co/300x200/cccccc/ffffff?text=Image+Error'"
            />
            <div class="p-4 flex-1 flex flex-col justify-between">
              <div>
                <div class="flex justify-between items-center mb-2">
                  <span class="text-lg font-bold text-emerald-600">${request.wasteType}</span>
                  ${this.getStatusChip(request.status)}
                </div>
                <p class="text-gray-700 font-medium">${request.address}</p>
                <p class="text-sm text-gray-500 mt-1">${this.timeAgo(request.timestamp)}</p>
                ${request.description ? `
                  <p class="text-sm text-gray-600 mt-2 italic border-l-4 border-gray-200 pl-2">
                    <strong>Note:</strong> ${request.description}
                  </p>
                ` : ''}
                ${collectorHtml}
              </div>
              ${buttonHtml}
            </div>
          </div>
        `;
      },
      
      // --- CORE LOGIC HANDLERS ---
      
      handleAuthFormSubmit(event, role, mode) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        // --- Real App: Firebase Auth ---
        // In a real app, you would use Firebase Auth here:
        // if (mode === 'register') {
        //   await createUserWithEmailAndPassword(auth, email, password);
        //   await setDoc(doc(db, "users", auth.currentUser.uid), { ... });
        // } else {
        //   await signInWithEmailAndPassword(auth, email, password);
        // }
        // For this demo, we just simulate it.
        
        if (mode === 'register') {
          const password = formData.get('password');
          const confirmPassword = formData.get('confirmPassword');
          if (password !== confirmPassword) {
            this.setError("Passwords do not match.");
            return;
          }
        }
        this.login(role); // Use our simulated login
      },
      
      handleNewRequest(requestData) {
        if (!requestData.address || !requestData.wasteType) {
          this.setError('Please fill in all fields.');
          return;
        }
        
        const newRequest = {
          id: this.db.pickupRequests.length + 10,
          householdId: this.loggedInUser.uid,
          address: requestData.address,
          wasteType: requestData.wasteType,
          description: requestData.description || '',
          photoUrl: `https://placehold.co/300x200/2ecc71/ffffff?text=${requestData.wasteType.replace(' ', '+')}`,
          status: 'pending',
          collectorId: null,
          timestamp: new Date().toISOString(),
        };
        
        // --- Real App: Firebase Integration ---
        // await addDoc(collection(db, "pickupRequests"), newRequest);
        this.db.pickupRequests.unshift(newRequest);
        this.navigate('dashboard');
      },
      
      handleAcceptRequest(requestId) {
        const request = this.db.pickupRequests.find(r => r.id === requestId);
        if (request) {
          // --- Real App: Firebase Integration ---
          // const docRef = doc(db, "pickupRequests", request.id);
          // await updateDoc(docRef, {
          //   status: 'accepted',
          //   collectorId: this.loggedInUser.uid
          // });
          request.status = 'accepted';
          request.collectorId = this.loggedInUser.uid;
        }
        this.render(); // Re-render the collector dashboard
      },
      
      handleCompleteRequest(requestId) {
        const request = this.db.pickupRequests.find(r => r.id === requestId);
        if (request) {
          // --- Real App: Firebase Integration ---
          // const docRef = doc(db, "pickupRequests", request.id);
          // await updateDoc(docRef, { status: 'completed' });
          request.status = 'completed';
        }
        this.render(); // Re-render the collector dashboard
      },
      
      handleRateSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const rating = parseInt(formData.get('rating'));
        const review = formData.get('review');
        const requestId = parseInt(event.target.dataset.requestId);
        const collectorId = event.target.dataset.collectorId;
        
        if (!rating) {
          this.setError("Please select a star rating.");
          return;
        }
        
        const request = this.db.pickupRequests.find(r => r.id === requestId);
        const collector = this.db.collectors.find(c => c.uid === collectorId);
        
        if (request && collector) {
          // --- Real App: Firebase Integration ---
          // 1. Update the request
          // const reqRef = doc(db, "pickupRequests", request.id);
          // await updateDoc(reqRef, { status: 'rated', rating: rating, review: review });
          request.status = 'rated';
          request.rating = rating;
          request.review = review;
          
          // 2. Update the collector's aggregate rating
          // This should be done in a secure Firebase Cloud Function
          // const newReviewCount = collector.reviewCount + 1;
          // const newRating = ((collector.rating * collector.reviewCount) + rating) / newReviewCount;
          // const collRef = doc(db, "collectors", collector.id);
          // await updateDoc(collRef, { rating: newRating, reviewCount: newReviewCount });
          
          // Simulate it for the demo
          const newReviewCount = collector.reviewCount + 1;
          const newRating = ((collector.rating * collector.reviewCount) + rating) / newReviewCount;
          collector.rating = newRating;
          collector.reviewCount = newReviewCount;
        }
        
        this.navigate('dashboard');
      },

      handleFileChange(event) {
        // ... (same as before)
        const file = event.target.files[0];
        const preview = document.getElementById('scan-preview');
        const placeholder = document.getElementById('scan-placeholder');
        const uploadLabel = document.getElementById('file-upload-label');
        const scanButton = document.getElementById('scan-button');
        const aiResultContainer = document.getElementById('ai-result-container');

        if (file) {
          aiResultContainer.innerHTML = '';
          const reader = new FileReader();
          
          reader.onloadend = () => {
            const base64String = reader.result.replace(/^data:.+;base64,/, '');
            this.base64Image = base64String;
            preview.src = reader.result;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
            uploadLabel.textContent = 'Change Image';
            scanButton.disabled = false;
          };
          reader.readAsDataURL(file);
        }
      },
      
      async handleScan() {
        // ... (same as before, no changes needed)
        if (!this.base64Image) {
          this.setError("Please upload an image first.");
          return;
        }

        this.setLoading(true);
        this.setError(null);
        document.getElementById('ai-result-container').innerHTML = '';

        const prompt = `Analyze this image of waste. Identify the primary object, its material, and the correct recycling bin for it. If it is not recyclable, label the bin as 'General Waste'. Respond in JSON format.`;
        
        const jsonSchema = {
          type: "OBJECT",
          properties: {
            "item_name": { "type": "STRING" },
            "material_type": { "type": "STRING" },
            "recycling_bin": { "type": "STRING" },
            "is_recyclable": { "type": "BOOLEAN" },
            "instructions": { "type": "STRING" }
          },
          required: ["item_name", "material_type", "recycling_bin", "is_recyclable", "instructions"]
        };

        const payload = {
          contents: [{
            role: "user",
            parts: [
              { text: prompt },
              { inlineData: { mimeType: "image/jpeg", data: this.base64Image } }
            ]
          }],
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: jsonSchema,
          }
        };

        let response;
        let delay = 1000;
        for (let i = 0; i < 3; i++) {
          try {
            response = await fetch(GEMINI_API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (response.status === 429) { // Rate limit
              await new Promise(res => setTimeout(res, delay));
              delay *= 2;
              continue;
            }
            if (response.ok) break; // Success
          } catch (error) {
            if (i === 2) {
              this.setError("Network error. Please try again.");
              this.setLoading(false);
              return;
            }
            await new Promise(res => setTimeout(res, delay));
            delay *= 2;
          }
        }
        
        this.setLoading(false);
        this.base64Image = null; // Clear image after scan
        document.getElementById('scan-button').disabled = true;

        if (!response || !response.ok) {
          this.setError(`API request failed. Status: ${response?.status}. Please try again.`);
          return;
        }

        try {
          const result = await response.json();
          const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
          
          if (text) {
            const aiResult = JSON.parse(text);
            const resultHtml = `
              <div class="bg-emerald-50 border border-emerald-200 p-4 rounded-lg space-y-2 animate-fadeIn">
                <h3 class="text-lg font-semibold text-emerald-800">Scan Result</h3>
                <p><strong>Item:</strong> ${aiResult.item_name}</p>
                <p><strong>Material:</strong> ${aiResult.material_type}</p>
                <p><strong>Recycle Bin:</strong> 
                  <span class="font-bold ${aiResult.is_recyclable ? 'text-emerald-700' : 'text-gray-700'}">
                    ${aiResult.recycling_bin}
                  </span>
                </p>
                <p><strong>Instructions:</strong> ${aiResult.instructions}</p>
              </div>
            `;
            document.getElementById('ai-result-container').innerHTML = resultHtml;
          } else {
            this.setError("Could not get a valid analysis from the AI. Please try a different image.");
          }
        } catch (e) {
          this.setError("Failed to parse AI response. ".e);
        }
      },
      
    };

    // --- Start the app ---
    document.addEventListener('DOMContentLoaded', () => {
      app.init();
    });
  </script>

</body>
</html>
